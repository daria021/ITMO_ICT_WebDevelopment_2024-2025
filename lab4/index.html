<!doctype html>
<html lang="en">

<head>
        <title>Лабораторная часть (коммерческий проект) - My Docs</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        
        
        

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
            <link rel="stylesheet" href="../assets/css/darcula-highlight.min.css">

        <link rel="stylesheet" href="../assets/css/bootstrap.min.css">
        <link rel="stylesheet" href="../assets/css/dracula-ui.min.css">
        <link rel="stylesheet" href="../assets/css/mkdocs.min.css">

        
            <link  rel="icon" type="image/x-icon" href="../assets/img/favicon.ico">
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
                <script>hljs.initHighlightingOnLoad();</script>

</head>

<body class="drac-bg-black-secondary drac-text-grey-ternary drac-text drac-scrollbar-purple">

    <main class="d-flex">

        <!-- block sidebar -->
            <nav id="sidebar" class="sidebar drac-bg-black">
    <div class="custom-menu">
        <button type="button" id="sidebarCollapse" class="btn btn-primary">
            <i class="fa fa-bars"></i>
            <span class="sr-only">Menu</span>
        </button>
    </div>

    <div class="p-4">
        

        <div class="drac-text-center">
            
                <span class="drac-text drac-line-height drac-text-white">My Docs</span>
            
        </div>

        <div class="drac-box flex-column">
            <ul class="dot-ul">
                <li><div class="dot-li drac-bg-cyan"></div></li>
                <li><div class="dot-li drac-bg-green"></div></li>
                <li><div class="dot-li drac-bg-orange"></div></li>
                <li><div class="dot-li drac-bg-pink"></div></li>
                <li><div class="dot-li drac-bg-purple"></div></li>
                <li><div class="dot-li drac-bg-red"></div></li>
                <li><div class="dot-li drac-bg-yellow"></div></li>
            </ul>
        </div>

        <hr class="drac-divider" />

        <!-- block menu -->
        <ul class="mb-5 drac-list drac-list-none">
            
            <li class="drac-box">
                <a href=".."
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Home
                </a>
            </li>
            <li class="drac-box">
                <a href=".."
                    class="
                    drac-anchor btn-toggle d-inline-flex align-items-center border-0 drac-text-purple--hover collapsed"
                    data-bs-toggle="collapse" data-bs-target="#lab-1-collapse" aria-expanded="false">
                    Lab 1
                </a>
                <div class="collapse" id="lab-1-collapse">
                    <ul class="mb-5 drac-list drac-list-none">
                            
    <li class="drac-box-ternary">
        <a href="../lab1/1/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            task 1
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../lab1/2/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            task 2
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../lab1/3/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            task 3
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../lab1/4/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            task 4
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../lab1/5/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            task 5
        </a>
    </li>
                    </ul>
                </div>
            </li>
            <li class="drac-box">
                <a href="../lab2/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Lab 2
                </a>
            </li>
            <li class="drac-box">
                <a href=".."
                    class="
                    drac-anchor btn-toggle d-inline-flex align-items-center border-0 drac-text-purple--hover collapsed"
                    data-bs-toggle="collapse" data-bs-target="#lab-3-collapse" aria-expanded="false">
                    Lab 3
                </a>
                <div class="collapse" id="lab-3-collapse">
                    <ul class="mb-5 drac-list drac-list-none">
                            
    <li class="drac-box-ternary">
        <a href="../lab3/practical_work/3.1/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Практическая часть 3.1
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../lab3/practical_work/3.2/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Практическая часть 3.2 - Обзор проекта
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../lab3/laboratory_works/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Лабораторная часть
        </a>
    </li>
                    </ul>
                </div>
            </li>
            <li class="drac-box">
                <a href=".."
                    class=" active 
                    drac-anchor btn-toggle d-inline-flex align-items-center border-0 drac-text-purple--hover collapsed"
                    data-bs-toggle="collapse" data-bs-target="#lab-4-collapse" aria-expanded="false">
                    Lab 4
                </a>
                <div class="collapse" id="lab-4-collapse">
                    <ul class="mb-5 drac-list drac-list-none">
                            
    <li class="drac-box-ternary">
        <a href="./"
            class=" active 
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Лабораторная часть (коммерческий проект)
        </a>
    </li>
                    </ul>
                </div>
            </li>
        </ul>
        <!-- endblock -->
    </div>
</nav>
        <!-- endblock -->

        <nav class="divider drac-bg-purple-cyan"></nav>

        <div class="content">
            <!-- block header -->
                <header>
    <nav class="navbar navbar-expand-xl drac-bg-purple">
        <div class="container-fluid">
            
            <button class="navbar-toggler w-100 text-center" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsMenu"
                aria-controls="navbarsMenu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse flex-column ml-auto" id="navbarsMenu">
                <ul class="navbar-nav text-md-center">

                    <!-- block preview -->
                    <li class="nav-item">
                            
        <div class="container">
            <div class="row row-preview">
                <div class="col">
                    <a href="../lab3/laboratory_works/"
                        class="btn-preview drac-btn drac-btn-outline drac-text-white drac-text-cyan-green--hover">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </div>
                <div class="col">
                    <a 
                        class="btn-preview drac-btn drac-text-white--hover disabled" style="padding-left: 3%;">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
                    </li>
                    <!--  endblock -->

                    <!-- block search -->
                    <li class="nav-item"><div role="search" class="search-box">
	<form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
		<input type="text" name="q" class="drac-input drac-input-search drac-input-white drac-text-white drac-bg-black-secondary"
		placeholder="Search docs" title="Type search term here" />
	</form>
</div>
                    </li>
                    <!--  endblock -->

                    <!-- block source -->
                    <li class="nav-item">
                        
                    </li>
                    <!--  endblock -->

                </ul>
            </div>

        </div>
    </nav>
</header>
            <!-- endblock -->

            <!-- block content -->
                <section class="p-md-5 section-content">
    <article>
        <p><h1 id="no4">Лабораторная работа №4: Разработка интерфейсов и интеграция с серверной частью</h1>
<h2 id="_1">Задача проекта</h2>
<p>Разработать клиентские интерфейсы для работы с платформой предсказательного беттинга на базе блокчейна, настроить их взаимодействие с серверной частью.</p>
<h2 id="_2">Используемые библиотеки и их назначение</h2>
<h3 id="_3">Для фронтенда:</h3>
<ul>
<li><code>@tonconnect/ui-react</code>: Управление подключением кошелька и интеграцией с блокчейном Ton.</li>
<li><code>react</code>, <code>react-router-dom</code>: Реализация пользовательского интерфейса с навигацией.</li>
<li><code>tailwindcss</code>: Современный CSS-фреймворк для стилизации компонентов.</li>
<li><code>react-select</code>: Улучшенные выпадающие списки для выбора торговых пар.</li>
<li><code>react-toastify</code>: Уведомления об ошибках, успехах и других событиях.</li>
</ul>
<h2 id="_4">Описание страниц интерфейса</h2>
<h3 id="_5">Главная страница</h3>
<ul>
<li><strong>Описание</strong>: Начальная страница, приветствующая пользователей и предоставляющая возможность подключения кошелька.</li>
<li><strong>Основные функции</strong>:</li>
<li>Приветственное сообщение и описание платформы.</li>
<li>Кнопка TonConnect для подключения кошелька.</li>
<li>Кнопки "Играть" и "Узнать больше" для навигации.
<img alt="img_1.png" src="img_1.png" />
<img alt="img_2.png" src="img_2.png" /></li>
</ul>
<h4 id="_6">Логика реализации:</h4>
<ul>
<li><strong>Подключение кошелька</strong>: Используется <code>TonConnectButton</code> для взаимодействия с TonConnect.</li>
<li><strong>Предзагрузка данных</strong>: При помощи функций <code>getPairs()</code> и <code>fetchTime()</code> данные о парах и текущем времени блока загружаются и сохраняются в контексте через <code>setData</code>.</li>
<li><strong>Обработка ошибок</strong>: Ошибки подключения и загрузки данных отображаются в пользовательском интерфейсе.</li>
<li><strong>Переходы</strong>: Кнопки навигации управляют переходом на другие страницы с использованием <code>useNavigate</code>.</li>
</ul>
<h3 id="_7">Страница ставок</h3>
<ul>
<li><strong>Описание</strong>: Предоставляет интерфейс для выбора торговых пар и размещения ставок. При первом открытии пользователю показываются инструкции.</li>
<li><strong>Основные функции</strong>:</li>
<li>Выбор торговой пары.</li>
<li>Ввод предсказания (вектор цены/направления движения).</li>
<li>Подтверждение и отправка ставки.
<img alt="img_3.png" src="img_3.png" /></li>
<li>на изображении: желтая стрелка - агрегированная ставка всех пользователей за прошлый блок, белая стрелка - ставка юзера за прошлый блок, ее же можно двигать, переключая моды осей, чтобы пояставить новую ставку.</li>
</ul>
<h4 id="_8">Логика реализации:</h4>
<ul>
<li><strong>Трёхмерный интерфейс ставок</strong>: Пользователи видят трехмерный график, на котором агрегированные ставки всех участников за прошлый блок и своя ставка в виде стрелок на графике.</li>
<li><strong>Обратная связь</strong>: После отправки пользователь получает уведомление о статусе ставки.</li>
</ul>
<h3 id="_9">Страница управления кошельком</h3>
<ul>
<li><strong>Описание</strong>: Позволяет пользователю управлять балансом кошелька, включая пополнение и вывод средств.</li>
<li><strong>Основные функции</strong>:</li>
<li>Форма пополнения депозита через TON.</li>
<li>Форма вывода средств на кошелек юзера.</li>
<li>История транзакций с отображением их статуса.</li>
<li>История ставок с отображением их статуса.
<img alt="img_5.png" src="img_5.png" /></li>
</ul>
<h4 id="_10">Логика реализации:</h4>
<ul>
<li><strong>Обработка пополнения</strong>: Запросы на сервер для обработки депозитов и их конвертации в токены платформы.</li>
<li><strong>Вывод средств</strong>: Инициирование транзакции на указанный адрес (есть возможность сменить адрес).</li>
</ul>
<h3 id="_11">Страница балансов юзера</h3>
<ul>
<li><strong>Описание</strong>: Позволяет пользователю узнать его оставшийся депозит в игре, а также количество токенов находящихся 'at risk'. </li>
<li><strong>Основные функции</strong>:</li>
<li>Отображение балансов юзера.</li>
<li>Кнопка для отключения кошелька.
<img alt="img_4.png" src="img_4.png" /></li>
</ul>
<h4 id="_12">Логика реализации:</h4>
<ul>
<li><strong>Обработка пополнения</strong>: Запросы на сервер для плучения балансов.</li>
</ul>
<h2 id="_13">Реализация авторизации</h2>
<h4 id="_14">Диаграмма процесса авторизации</h4>
<p><img alt="img.png" src="img.png" /></p>
<h3 id="_15">Описание работы</h3>
<p>Авторизация на платформе организована через интеграцию с блокчейном Ton и использованием механизма <code>ton_proof</code>. Весь процесс проходит несколько ключевых этапов:</p>
<ol>
<li><strong>Подключение кошелька:</strong></li>
<li>Клиент отправляет запрос на сервер для генерации <code>payload</code>.</li>
<li>
<p>Пользователь подключает кошелёк через интерфейс TonConnect на клиенте, отправляя <code>payload</code> контракту кошелька.</p>
</li>
<li>
<p><strong>Подписание proof:</strong></p>
</li>
<li>Полученный <code>payload</code> подписывается приватным ключом кошелька пользователя.</li>
<li>
<p>Подписанный <code>proof</code> возвращается клиенту, а затем отправляется на сервер для проверки.</p>
</li>
<li>
<p><strong>Проверка proof:</strong></p>
</li>
<li>Сервер валидирует подпись, используя публичный ключ кошелька пользователя пользователя.</li>
<li>
<p>Если proof валиден, сервер генерирует пару токенов (access и refresh) и отправляет их клиенту.</p>
</li>
<li>
<p><strong>Хранение и использование токенов:</strong></p>
</li>
<li>Токены сохраняются в <code>localStorage</code> на клиенте и используются для авторизации запросов к API.</li>
<li>При истечении срока действия токенов клиент автоматически обновляет их через refresh-токен.</li>
</ol>
<h3 id="_16">Основные компоненты</h3>
<h4 id="1">1. Фронтенд: Контекст авторизации</h4>
<pre><code class="language-tsx">import React, { createContext, useContext } from &quot;react&quot;;
import { verifyPayload } from &quot;../services/api&quot;;

const AuthContext = createContext();

export const AuthProvider = ({ children }) =&gt; {
  const loginWithProof = async (proofData) =&gt; {
    const { accessToken, refreshToken } = await verifyPayload(proofData);
    localStorage.setItem(&quot;authToken&quot;, accessToken);
    localStorage.setItem(&quot;refreshToken&quot;, refreshToken);
  };

  return (
    &lt;AuthContext.Provider value={{ loginWithProof }}&gt;{children}&lt;/AuthContext.Provider&gt;
  );
};
</code></pre>
<p><strong>Объяснение:</strong>
- Функция <code>loginWithProof</code> выполняет запрос на сервер для проверки <code>proof</code> и сохраняет токены в локальное хранилище.</p>
<h3 id="2">2. Фронтенд: Интерсепторы для обновления токенов</h3>
<p><strong>Интерсепторы</strong> помогают автоматически обрабатывать запросы и ответы API. Это особенно полезно для управления обновлением токенов, когда срок действия текущего токена истекает.</p>
<h4 id="_17">Код настройки интерсепторов</h4>
<ol>
<li><strong>Создание экземпляра Axios:</strong></li>
</ol>
<pre><code class="language-typescript">const apiClient = axios.create({
 baseURL: BASE_URL,
});
</code></pre>
<p>Здесь создаётся экземпляр <code>axios</code> с базовым URL, указывающим на API сервера. Все запросы будут направляться на этот адрес.</p>
<ol>
<li><strong>Получение токенов из локального хранилища:</strong></li>
</ol>
<pre><code class="language-typescript">function getAccessToken(): string | null {
 return localStorage.getItem(&quot;authToken&quot;);
}

function getRefreshToken(): string | null {
 return localStorage.getItem(&quot;refreshToken&quot;);
}
</code></pre>
<p>Эти функции возвращают токены из <code>localStorage</code>, если они существуют, или <code>null</code>, если токен отсутствует.</p>
<ol>
<li><strong>Обновление токенов:</strong></li>
</ol>
<pre><code class="language-typescript">const refreshAuthLogic = (failedRequest: AxiosError) =&gt;
 apiClient
   .post&lt;RefreshedTokens&gt;(
     &quot;/auth/refresh&quot;,
     {},
     {
       headers: {
         &quot;X-Refresh-Token&quot;: getRefreshToken(),
       },
     }
   )
   .then((tokenRefreshResponse) =&gt; {
     localStorage.setItem(&quot;authToken&quot;, tokenRefreshResponse.data.accessToken);
     localStorage.setItem(
       &quot;refreshToken&quot;,
       tokenRefreshResponse.data.refreshToken,
     );
     failedRequest.response!.config.headers[&quot;Authorization&quot;] =
       &quot;Bearer &quot; + tokenRefreshResponse.data.accessToken;
     return Promise.resolve();
   });
</code></pre>
<p>Когда запрос получает ошибку 401 (Unauthorized), интерсептор автоматически вызывает <code>/auth/refresh</code> для получения новых токенов.</p>
<ol>
<li><strong>Интеграция с <code>axios-auth-refresh</code>:</strong></li>
</ol>
<pre><code class="language-typescript">createAuthRefreshInterceptor(apiClient, refreshAuthLogic, {
 pauseInstanceWhileRefreshing: true,
});
</code></pre>
<p>Эта библиотека упрощает процесс обновления токенов, автоматически выполняя логику из <code>refreshAuthLogic</code> для каждого запроса с истёкшим токеном.</p>
<ol>
<li><strong>Обработка запросов:</strong></li>
</ol>
<pre><code class="language-typescript">apiClient.interceptors.request.use(
 (config) =&gt; {
   const token = getAccessToken();
   if (token) {
     config.headers.Authorization = `Bearer ${token}`;
   }
   return config;
 },
 (error) =&gt; Promise.reject(error),
);
</code></pre>
<p>Этот интерсептор добавляет заголовок <code>Authorization</code> ко всем запросам, если токен авторизации доступен.</p>
<h3 id="3">3. Логика авторизации на главной странице</h3>
<h4 id="homepage">Код авторизации на <code>HomePage</code></h4>
<hr />
<h4 id="tonconnect">Взаимодействия с TonConnect на главной странице</h4>
<pre><code class="language-tsx">useEffect(() =&gt; {
    tonConnectUI.setConnectRequestParameters({ state: &quot;loading&quot; });
    const initTonConnect = async () =&gt; {
      try {
        const tonProofPayload = await getPayload();

        if (tonProofPayload) {
          tonConnectUI.setConnectRequestParameters({
            state: &quot;ready&quot;,
            value: { tonProof: tonProofPayload.payload },
          });
        } else {
          tonConnectUI.setConnectRequestParameters(null);
        }
      } catch (error) {
        console.error(&quot;[HomePage]: Error during initialization:&quot;, error);
        setError(
          error instanceof Error ? error.message : &quot;Unknown error occurred.&quot;
        );
      } finally {
        setLoading(false);
      }
    };

    initTonConnect();
  }, []);
</code></pre>
<p><strong>Объяснение логики:</strong>
1. <strong>Инициализация TonConnect:</strong>
   - <code>tonConnectUI.setConnectRequestParameters</code> сначала устанавливает состояние как <code>loading</code>, что указывает на начальную загрузку.
   - Затем происходит асинхронный вызов функции <code>getPayload</code>, которая обращается к серверу для получения уникального <code>tonProofPayload</code>.</p>
<ol>
<li><strong>Установка параметров подключения:</strong></li>
<li>Если <code>tonProofPayload</code> успешно получен, он передается в <code>tonConnectUI</code> для установки параметров подключения.</li>
<li>
<p>Если загрузка не удалась, параметры сбрасываются.</p>
</li>
<li>
<p><strong>Обработка ошибок:</strong></p>
</li>
<li>
<p>Ошибки при выполнении асинхронного кода обрабатываются и логируются. В случае ошибки пользователь получает сообщение.</p>
</li>
<li>
<p><strong>Завершение загрузки:</strong></p>
</li>
<li>Независимо от результата, состояние загрузки (<code>loading</code>) завершается.</li>
</ol>
<hr />
<h4 id="4">4.Запросы к бэкенду</h4>
<p>Клиентское приложение взаимодействует с сервером через API, используя предварительно настроенный клиент Axios. Вот пример одного из запросов:</p>
<pre><code class="language-typescript">export async function getUserBets(): Promise&lt;UserBetsResponse&gt; {
    try {
        const response = await apiClient.get&lt;UserBetsResponse&gt;(&quot;/user/bets&quot;);
        return response.data;
    } catch (error) {
        console.error(&quot;Error fetching user bets:&quot;, error);
        throw error;
    }
}
</code></pre>
<p><strong>Объяснение:</strong>
1. <strong>Назначение:</strong> 
   Запрос получает список ставок пользователя, обращаясь к эндпоинту <code>/user/bets</code>.</p>
<ol>
<li><strong>Обработка ошибок:</strong></li>
<li>Любая ошибка при выполнении запроса логируется.</li>
<li>
<p>Если сервер недоступен или вернул ошибку, она пробрасывается в вызывающий компонент.</p>
</li>
<li>
<p><strong>Типизация:</strong></p>
</li>
<li>Используется строгая типизация ответа с помощью <code>Promise&lt;UserBetsResponse&gt;</code>, что позволяет интегрироваться с остальными компонентами приложения.</li>
</ol>
<hr />
<h3 id="5-prefetcheddata">5.Описание <code>PrefetchedData</code> и связанных запросов</h3>
<hr />
<p><code>PrefetchedData</code> представляет собой контекст для управления ключевыми данными приложения, такими как список торговых пар, данные свечей, текущее время блока и выбранная пара. Этот подход улучшает производительность приложения за счет предварительной загрузки данных и их централизованного управления.</p>
<h4 id="prefetcheddata">Как работает <code>PrefetchedData</code></h4>
<ol>
<li><strong>Инициализация контекста:</strong>
   Контекст создается для хранения данных, методов управления и состояния загрузки. Он включает:</li>
<li><code>pairs</code> — список доступных торговых пар.</li>
<li><code>candles</code> — данные свечей для выбранной пары.</li>
<li><code>time</code> — оставшееся время текущего блока.</li>
<li><code>selectedPair</code> — выбранная пользователем пара.</li>
<li>
<p>Методы для загрузки данных (<code>fetchCandlesForPair</code>) и выбора пары (<code>setSelectedPair</code>).</p>
</li>
<li>
<p><strong>Параллельные запросы в <code>useEffect</code>:</strong>
   Внутри <code>useEffect</code> запускаются два параллельных запроса:</p>
</li>
<li>Для получения списка пар (<code>fetchPairs</code>).</li>
<li>
<p>Для получения времени блока (<code>fetchTimeData</code>).</p>
</li>
<li>
<p><strong>Реализация запросов:</strong></p>
</li>
</ol>
<h5 id="fetchpairs">Загрузка пар (<code>fetchPairs</code>):</h5>
<pre><code class="language-tsx">const fetchPairs = async (): Promise&lt;void&gt; =&gt; {
  try {
    const pairsResponse = await getPairs();

    if (!pairsResponse || !Array.isArray(pairsResponse)) {
      console.warn(&quot;Данные пар невалидны, повторный запрос через 5 секунд...&quot;);
      setTimeout(fetchPairs, 5000);
      return;
    }

    const pairs = pairsResponse.map((pair) =&gt; ({
      value: pair.pair_id,
      label: pair.name,
    }));
    console.log(&quot;pairs&quot;, pairs);
    setData((prev) =&gt; ({ ...prev, pairs })); // Обновляем только пары
  } catch (error) {
    console.error(&quot;Ошибка при загрузке пар:&quot;, error);
    setTimeout(fetchPairs, 5000); // Повторяем запрос через 5 секунд
  }
};
</code></pre>
<p><strong>Логика:</strong>
- Получает данные через API-запрос к <code>/pair</code>.
- Проверяет валидность ответа и преобразует его в формат, подходящий для использования в <code>react-select</code>.
- При ошибке повторяет запрос через 5 секунд.</p>
<h5 id="fetchtimedata">Загрузка времени блока (<code>fetchTimeData</code>):</h5>
<pre><code class="language-tsx">const fetchTimeData = async (): Promise&lt;void&gt; =&gt; {
  try {
    const timeResponse = await fetchTime();

    if (!timeResponse || timeResponse.remaining_time_in_block === 0) {
      console.warn(&quot;Данные времени невалидны, повторный запрос через 5 секунд...&quot;);
      setTimeout(fetchTimeData, 5000);
      return;
    }
    console.log(&quot;time&quot;, timeResponse);
    setData((prev) =&gt; ({ ...prev, time: timeResponse.remaining_time_in_block })); // Обновляем только время
  } catch (error) {
    console.error(&quot;Ошибка при загрузке времени:&quot;, error);
    setTimeout(fetchTimeData, 5000); // Повторяем запрос через 5 секунд
  }
};
</code></pre>
<p><strong>Логика:</strong>
- Получает время блока через API-запрос к <code>/chain/time</code>.
- Проверяет корректность данных времени и обновляет состояние.
- При ошибке также запускает повторный запрос.</p>
<hr />
<h4 id="prefetcheddata_1">Связь запросов с <code>PrefetchedData</code></h4>
<ul>
<li>
<p><strong>Инициализация данных:</strong> При загрузке страницы в <code>useEffect</code> происходит вызов двух функций:
  <code>tsx
  useEffect(() =&gt; {
    const fetchData = (): void =&gt; {
      fetchPairs();
      fetchTimeData();
    };
    fetchData(); // Запускаем первый цикл запросов
  }, [data.selectedPair]);</code>
  Эти функции обновляют <code>pairs</code> и <code>time</code> внутри <code>PrefetchedData</code>, что делает их доступными для компонентов.</p>
</li>
<li>
<p><strong>Обновление данных свечей:</strong> Когда пользователь выбирает пару, <code>setSelectedPair</code> автоматически вызывает <code>fetchCandlesForPair</code>, чтобы обновить свечи для выбранной пары:
  <code>tsx
  const setSelectedPair = (pair: PairOption | null) =&gt; {
    setData((prev) =&gt; ({ ...prev, selectedPair: pair }));
    if (pair?.value) {
      fetchCandlesForPair(pair.value);
    }
  };</code></p>
</li>
</ul>
<h5 id="fetchcandlesforpair">Загрузка свечей (<code>fetchCandlesForPair</code>):</h5>
<pre><code class="language-tsx">const fetchCandlesForPair = async (pairId: string) =&gt; {
  setData((prev) =&gt; ({ ...prev, isLoading: true, error: null }));
  try {
    const candles = await fetchCandles(pairId);
    setData((prev) =&gt; ({ ...prev, candles, isLoading: false }));
    console.log(&quot;data.candles&quot;, candles);
  } catch (err) {
    console.error(`Ошибка при загрузке данных для пары ${pairId}:`, err);
    setData((prev) =&gt; ({
      ...prev,
      error: (err as Error).message || &quot;Не удалось загрузить данные свечей&quot;,
      isLoading: false,
    }));
  }
};
</code></pre>
<p><strong>Логика:</strong>
- Загружает данные свечей через API-запрос.
- Обновляет <code>candles</code> в <code>PrefetchedData</code>, что делает их доступными для визуализации.
<img alt="img_6.png" src="img_6.png" /></p></p>
    </article>
</section>
            <!-- endblock -->

            <!-- block footer -->
                <footer>
    <div class="d-flex flex-sm-row justify-content-between py-2 border-top drac-text-black drac-bg-cyan-green">
        <a href="https://github.com/dracula/mkdocs" target="_blank" style="padding-left: 1%;"
            class="footer-text drac-anchor drac-text-black drac-text-purple--hover">
            Made with Dracula Theme for MkDocs
        </a>
    </div>
</footer>
            <!-- endblock -->
        </div>

    </main>

        <script>var base_url = '..';</script>
        <script src="../assets/js/jquery-3.3.1.slim.min.js"></script>
        <script src="../assets/js/bootstrap.bundle.min.js"></script>
        <script src="../assets/js/mkdocs.js"></script>
			<script src="../search/main.js" defer></script>

</body>

</html>